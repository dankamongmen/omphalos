#!/bin/sh
# postinst script for omphalos
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package

USBIDS=/usr/share/omphalos/usb.ids
OUIIDS=/usr/share/omphalos/ieee-oui.txt

OUI="`which get-oui 2> /dev/null`" || true
WGET="`which wget 2> /dev/null`" || true
ICONV="`which iconv 2> /dev/null`" || true

# We have a hard Depends on libcap2-bin; don't accept a lookup failure
SETCAP="`which setcap 2> /dev/null`"

tmp="`mktemp`"

exithandle () {
        trap "" EXIT
        if [ -n "$tmp" ] ; then
                rm -vf "$tmp" || true
        fi
}

trap exithandle EXIT SIGINT SIGHUP

bless () {
	for i in "$@" ; do
		# don't fall back to generic root setuid
		"$SETCAP" "= cap_net_admin,cap_net_raw=ep" "$i"
	done
}

case "$1" in
    configure)
	mkdir -p /usr/share/omphalos
	if [ -z "$WGET" ] ; then
		echo "Couldn't find wget; not updating USB IDs." >&2
	elif [ -z "$ICONV" ] ; then
		echo "Couldn't find iconv; not updating USB IDs." >&2
	else
		"$WGET" http://www.linux-usb.org/usb.ids -O "$tmp"
		"$ICONV" -f iso-8859-1 -t utf-8 -o $USBIDS "$tmp"
	fi
	if [ -z "$OUI" ] ; then
		echo "Couldn't find get-oui; not updating OUI IDs." >&2
	elif [ -z "$ICONV" ] ; then
		echo "Couldn't find iconv; not updating OUI IDs." >&2
	else
		"$OUI" -v -f "$tmp"
		"$ICONV" -f iso-8859-1 -t utf-8 -o "$OUIIDS" "$tmp"
	fi
	bless /usr/bin/omphalos-*
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

rm "$tmp"
tmp=""

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
